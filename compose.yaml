version: "3.8"

services:
  mariadb:
    image: gyeongditor/mariadb:11.4
    container_name: storyfield-mariadb
    restart: unless-stopped
    ports:
      - "4306:3306"
    env_file:
      - ./.env
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    image: gyeongditor/storyfield-redis:latest
    container_name: storyfield-redis
    depends_on:
      - mariadb
    restart: unless-stopped
    ports:
      - "8379:6379"

  fastapi:
    image: gyeongditorai/story-field-ai:latest
    container_name: storyfield-fastapi
    restart: unless-stopped
    ports:
      - "8001:8000"
    env_file:
      - ./.env

  app:
    image: gyeongditor/story-field-be:latest
    container_name: storyfield-app
    depends_on:
      - mariadb
      - redis
      - fastapi
    restart: unless-stopped
    ports:
      - "9080:8080"
    env_file:
      - ./.env
    environment:
      DB_HOST: mariadb
      DB_PORT: "3306"
    entrypoint:
      - sh
      - -c
      - |
        set -e
        echo "üîé checking MariaDB at ${DB_HOST}:${DB_PORT}"
        until nc -z "$$DB_HOST" "$$DB_PORT"; do
          echo "‚è≥ waiting for MariaDB..."
          sleep 1
        done
        echo "‚úÖ MariaDB OK"
        echo "üîé checking FastAPI at fastapi:8000"
        until nc -z fastapi 8000; do
          echo "‚è≥ waiting for FastAPI..."
          sleep 1
        done
        echo "‚úÖ FastAPI OK"
        exec java -jar /app/app.jar

volumes:
  mariadb_data:
