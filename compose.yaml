version: "3.8"

services:
  mysql:
    image: gyeongditor/mysql-custom:latest
    container_name: storyfield-mysql
    restart: unless-stopped
    ports:
      - "4307:3306"

  redis:
    image: gyeongditor/storyfield-redis:latest
    container_name: storyfield-redis
    depends_on:
      - mysql
    restart: unless-stopped
    ports:
      - "8379:6379"

  fastapi:
    image: gyeongditorai/story-field-ai:latest
    container_name: storyfield-fastapi
    restart: unless-stopped
    ports:
      - "8001:8000"
    env_file:
      - ./.env

  app:
    image: gyeongditor/story-field-be:latest
    container_name: storyfield-app
    depends_on:
      - mysql
      - redis
      - fastapi
    restart: unless-stopped
    ports:
      - "9080:8080"
    # ì—¬ê¸°ì„œ .envë¥¼ ì»¨í…Œì´ë„ˆ í™˜ê²½ìœ¼ë¡œ ì£¼ì…
    env_file:
      - ./.env
    # DB/FastAPI ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ì‹¤í–‰ (wait-for-it.sh ë¶ˆí•„ìš”)
    environment:
      DB_HOST: mysql
      DB_PORT: "3306"
    entrypoint:
      - sh
      - -c
      - |
        set -e
        echo "ğŸ” checking MySQL at ${DB_HOST}:${DB_PORT}"
        until nc -z "$$DB_HOST" "$$DB_PORT"; do
          echo "â³ waiting for MySQL..."
          sleep 1
        done
        echo "âœ… MySQL OK"
        echo "ğŸ” checking FastAPI at fastapi:8000"
        until nc -z fastapi 8000; do
          echo "â³ waiting for FastAPI..."
          sleep 1
        done
        echo "âœ… FastAPI OK"
        exec java -jar /app/app.jar
