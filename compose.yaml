version: "3.8"

services:
  mysql:
    image: gyeongditor/mysql-custom:latest
    container_name: storyfield-mysql
    restart: unless-stopped
    ports:
      - "4307:3306"

  redis:
    image: gyeongditor/storyfield-redis:latest
    container_name: storyfield-redis
    depends_on:
      - mysql
    restart: unless-stopped
    ports:
      - "8379:6379"

  fastapi:
    image: gyeongditorai/story-field-ai:latest
    container_name: storyfield-fastapi
    restart: unless-stopped
    ports:
      - "8001:8000"
    env_file:
      - ./.env

  app:
    image: gyeongditor/story-field-be:latest
    container_name: storyfield-app
    depends_on:
      - mysql
      - redis
      - fastapi
    restart: unless-stopped
    ports:
      - "9080:8080"
    # 여기서 .env를 컨테이너 환경으로 주입
    env_file:
      - ./.env
    # DB/FastAPI 준비될 때까지 대기 후 실행 (wait-for-it.sh 불필요)
    environment:
      DB_HOST: mysql
      DB_PORT: "3306"
    entrypoint:
      - sh
      - -c
      - |
        set -e
        echo "🔎 checking MySQL at ${DB_HOST}:${DB_PORT}"
        until nc -z "$$DB_HOST" "$$DB_PORT"; do
          echo "⏳ waiting for MySQL..."
          sleep 1
        done
        echo "✅ MySQL OK"
        echo "🔎 checking FastAPI at fastapi:8000"
        until nc -z fastapi 8000; do
          echo "⏳ waiting for FastAPI..."
          sleep 1
        done
        echo "✅ FastAPI OK"
        exec java -jar /app/app.jar
